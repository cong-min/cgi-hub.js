(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{354:function(t,s,e){"use strict";e.r(s);var a=e(42),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"请求生命周期"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#请求生命周期"}},[t._v("#")]),t._v(" 请求生命周期")]),t._v(" "),e("img",{attrs:{src:t.$withBase("/imgs/lifecycle.png"),alt:"请求生命周期"}}),t._v(" "),e("p",[e("code",[t._v("CgiHub.createRequest(lifecycle)")]),t._v(" 静态方法可以用来创建标准化的请求函数，其中参数 "),e("code",[t._v("lifecycle")]),t._v(" 代表了请求的生命周期：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("beforeFetch：")]),t._v(" 请求前")]),t._v(" "),e("li",[e("strong",[t._v("fetch：")]),t._v(" 请求方法")]),t._v(" "),e("li",[e("strong",[t._v("afterFetch：")]),t._v(" 请求后")]),t._v(" "),e("li",[e("strong",[t._v("errorHandler：")]),t._v(" 异常处理")])]),t._v(" "),e("p",[t._v("下面对 "),e("a",{attrs:{href:"https://github.com/mcc108/cgi-hub.js/blob/master/packages/cgi-hub.js/src/index.ts#L83",target:"_blank",rel:"noopener noreferrer"}},[t._v("createRequest 的实现"),e("OutboundLink")],1),t._v("进行解析，你就可以清楚了解整个请求流程的生命周期：")]),t._v(" "),e("div",{staticClass:"language-ts extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("div",{staticClass:"highlighted"},[t._v(" ")]),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-ts"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("request")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("requestOptions")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Promise")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求前")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("beforeFetch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求参数修改 options 重新赋值, 并传递给 fetch")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("opts")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestOptions "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" opts"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发起请求, 类型断言")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fetch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 请求后")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("response")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("afterFetch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" requestOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 统一异常处理")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("error")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("errorHandler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      error"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      requestOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// retry")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("resolve"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("request")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("requestOptions"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resolve"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("不难理解，它通过 "),e("code",[t._v("Promise")]),t._v(" 将请求流程串联，并进行统一的异常处理以及重试的支持。下面是每个钩子函数的详细说明：")]),t._v(" "),e("h2",{attrs:{id:"beforefetch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#beforefetch"}},[t._v("#")]),t._v(" beforeFetch")]),t._v(" "),e("p",[e("strong",[t._v("类型：")]),t._v(" "),e("code",[t._v("(requestOptions: Object) => Promise | Object")])]),t._v(" "),e("p",[t._v("请求前公共处理方法，传入请求参数，返回新的请求参数。")]),t._v(" "),e("p",[t._v("可以考虑在此处追加全局的数据或登录态、请求上报等。")]),t._v(" "),e("h2",{attrs:{id:"fetch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#fetch"}},[t._v("#")]),t._v(" fetch")]),t._v(" "),e("p",[e("strong",[t._v("类型：")]),t._v(" "),e("code",[t._v("(requestOptions: Object) => Promise | any")])]),t._v(" "),e("p",[t._v("请求时的基础方法，传入请求参数，返回一个 "),e("code",[t._v("Promise")]),t._v(" 响应数据。你可以包装自己喜爱的接口请求基础库，也可以基于文档提供的插件文件进行改动。")]),t._v(" "),e("p",[e("strong",[t._v("提供插件：")])]),t._v(" "),e("ul",[e("li",[t._v("Web\n"),e("ul",[e("li",[t._v("web-xhr.fetch.ts 待开发")]),t._v(" "),e("li",[t._v("web-fetch.fetch.ts 待开发")]),t._v(" "),e("li",[t._v("axios.fetch.ts 待开发")])])]),t._v(" "),e("li",[t._v("小程序\n"),e("ul",[e("li",[t._v("mp-native.fetch.ts 待开发")]),t._v(" "),e("li",[e("a",{attrs:{href:"../plugins/we-request.fetch.ts"}},[t._v("we-request.fetch.ts")])])])]),t._v(" "),e("li",[t._v("Node.js\n"),e("ul",[e("li",[t._v("node-native.fetch.js 待开发")])])])]),t._v(" "),e("h2",{attrs:{id:"afterfetch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#afterfetch"}},[t._v("#")]),t._v(" afterFetch")]),t._v(" "),e("p",[e("strong",[t._v("类型：")]),t._v(" "),e("code",[t._v("(response: any, requestOptions: Object) => Promise | any")])]),t._v(" "),e("p",[t._v("请求后公共处理方法，传入响应数据与请求参数，返回新的响应数据。")]),t._v(" "),e("p",[t._v("可以考虑在此处解析响应数据结构、抛出状态码异常、处理登录态、日志上报等。")]),t._v(" "),e("h2",{attrs:{id:"errorhandler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#errorhandler"}},[t._v("#")]),t._v(" errorHandler")]),t._v(" "),e("p",[e("strong",[t._v("类型：")]),t._v(" "),e("code",[t._v("(response: any, requestOptions: Object, retry) => Promise | any")]),e("br"),t._v(" "),e("strong",[t._v("参数 "),e("code",[t._v("retry")]),t._v(" 类型：")]),t._v(" "),e("code",[t._v("(resolve, reject) => Promise")])]),t._v(" "),e("p",[t._v("异常处理公共方法，传入响应数据与请求参数以及请求重试方法，返回一个 "),e("code",[t._v("Promise")]),t._v("，或者新的响应数据。")]),t._v(" "),e("p",[t._v("可以考虑在此处利用 "),e("code",[t._v("Promise")]),t._v(" 完成请求快速重试、通过错误装饰器判断内置错误提示方式、错误码提示映射、错误上报等。")]),t._v(" "),e("p",[e("strong",[t._v("提供插件：")])]),t._v(" "),e("ul",[e("li",[t._v("Web\n"),e("ul",[e("li",[t._v("element-ui.errorHandler.ts 待开发")])])]),t._v(" "),e("li",[t._v("小程序\n"),e("ul",[e("li",[e("a",{attrs:{href:"../plugins/mp.errorHandler.ts"}},[t._v("mp.errorHandler.ts")])])])]),t._v(" "),e("li",[t._v("Node.js")])])])}),[],!1,null,null,null);s.default=n.exports}}]);